"""
KOSPI200 Daily Batch 개선사항 - 중단된 배치 재시작 최적화

kospi200_daily_batch.py가 40개 정도 진행하다가 중단된 경우,
오늘 날짜 기준으로 이미 수집된 데이터는 자동으로 스킵하도록 개선했습니다.
"""

# 개선사항 요약
## 1. 오늘 날짜 데이터 자동 스킵
- 각 종목 처리 전에 오늘 날짜(YYYY-MM-DD) 데이터 존재 여부 확인
- 이미 존재하면 "⏭️ 스킵" 메시지와 함께 건너뛰기
- API 호출 및 대기 시간 없이 즉시 다음 종목으로 진행

## 2. 통계 정보 개선
- `skipped_stocks`: 스킵된 종목 수 추가
- 실제 작업한 종목 기준으로 성공률 계산
- 스킵률 별도 표시

## 3. 대기 시간 최적화
- 스킵된 종목의 경우 1초만 대기 (기존: 12-60초)
- 실제 데이터 수집한 종목만 정상 대기 시간 적용

## 4. 진행 상황 표시 개선
- 실시간으로 스킵된 종목 수 표시
- 실제 작업 종목 기준 성공률 표시

# 사용 방법

## 중단된 배치 재시작
```powershell
# 기본 실행 (자동으로 오늘 데이터 있는 종목은 스킵)
python kospi200_daily_batch.py

# 또는 배치 파일로
run_kospi200_batch.bat
```

## 예상 출력 예시
```
🔄 [1/200] 005930 (삼성전자) 처리 중...
   ⏭️ 005930 (삼성전자): 오늘(2025-08-06) 데이터 이미 존재 - 스킵
   📊 진행률: 0.5% | 성공률: 0.0% | 스킵: 1개 | 처리시간: 0.1초
   ⏩ 스킵으로 인한 짧은 대기 (1초)

🔄 [41/200] 000660 (SK하이닉스) 처리 중...
   📅 기존 데이터 있음 (최신: 2025-08-05) - 증분 수집
   📊 000660 (SK하이닉스) 일봉 데이터 수집 중... (최대 100개)
   ✅ 000660 (SK하이닉스): 1개 레코드 저장 완료
   📊 진행률: 20.5% | 성공률: 100.0% | 스킵: 40개 | 처리시간: 3.2초
```

## 최종 결과 예시
```
📊 최종 결과:
   전체 종목: 200개
   처리 종목: 200개
   성공 종목: 160개
   실패 종목: 0개
   스킵 종목: 40개 (오늘 데이터 존재)
   성공률: 100.0% (실제 작업 종목 기준)
   스킵률: 20.0% (전체 종목 기준)
   총 히스토리 레코드: 160개
   소요 시간: 0:08:32
```

# 장점

1. **시간 절약**: 이미 수집된 데이터는 스킵하여 전체 실행 시간 단축
2. **안전성**: 중복 수집 방지로 데이터 일관성 보장  
3. **효율성**: 필요한 종목만 API 호출하여 서버 부하 최소화
4. **재시작 안전**: 언제든지 중단 후 재시작 가능
5. **명확한 피드백**: 어떤 종목이 스킵되고 어떤 종목이 처리되는지 명확히 표시

# 주의사항

- 오늘 날짜(실행일) 기준으로 데이터 존재 여부를 확인합니다
- 장중에 실행하면 오늘 데이터가 있어도 가격이 다를 수 있습니다
- 강제로 모든 데이터를 재수집하려면 `--full` 옵션 사용:
  ```powershell
  python kospi200_daily_batch.py --full
  ```

이제 40개 진행 후 중단된 배치를 재시작하면 자동으로 처음 40개는 스킵되고 
41번째부터 빠르게 진행됩니다! 🚀
